<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Splitter - Fair Expense Sharing Tool</title>
    <style>
        :root {
            --primary: #4a6bdf;
            --primary-light: #e8f0fe;
            --secondary: #3a56c4;
            --accent: #6cdf4a;
            --dark: #2d3748;
            --light: #f7fafc;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --gray: #718096;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background-color: white;
            box-shadow: var(--box-shadow);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .logo-icon {
            font-size: 28px;
            color: var(--primary);
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
        }

        .logo-text span {
            color: var(--primary);
        }

        main {
            padding: 40px 0;
        }

        .app-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            margin-bottom: 40px;
            border: 1px solid #e2e8f0;
        }

        h1 {
            margin-bottom: 20px;
            color: var(--dark);
            text-align: center;
        }

        h2 {
            font-size: 22px;
            margin-top: 30px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e2e8f0;
            color: var(--primary);
        }

        .hidden {
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 107, 223, 0.2);
        }

        .btn {
            display: inline-block;
            background-color: var(--primary);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: var(--box-shadow);
        }

        .btn:hover {
            background-color: var(--secondary);
            transform: translateY(-2px);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-secondary {
            background-color: var(--success);
        }

        .btn-secondary:hover {
            background-color: #2d924a;
        }

        .btn-warning {
            background-color: var(--warning);
        }

        .btn-warning:hover {
            background-color: #d97706;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #d33426;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .back-button {
            position: absolute;
            left: 20px;
            top: 20px;
            background-color: #e2e8f0;
            color: var(--dark);
        }

        .back-button:hover {
            background-color: #e0e0e0;
        }

        .group-card {
            position: relative;
            padding-right: 100px;
            margin-bottom: 20px;
            border-left: 3px solid var(--primary);
            padding-left: 15px;
        }

        .group-actions {
            position: absolute;
            right: 20px;
            top: 20px;
            display: flex;
            gap: 10px;
        }

        .bill-card {
            border-left: 3px solid var(--primary);
            padding-left: 15px;
            margin-bottom: 15px;
            position: relative;
            padding-right: 100px;
        }

        .bill-actions {
            position: absolute;
            right: 20px;
            top: 10px;
            display: flex;
            gap: 10px;
        }

        .member-tag {
            display: inline-block;
            background-color: var(--primary);
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .settlement-card {
            background-color: var(--primary-light);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            position: relative;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .button-group button {
            margin-top: 0;
            flex: 1;
        }

        .empty-state {
            text-align: center;
            color: var(--gray);
            padding: 20px;
        }

        .member-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .member-input-container input {
            flex-grow: 1;
            margin-bottom: 0;
        }

        .results-list {
            list-style-type: none;
            padding: 0;
        }

        .results-list li {
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .results-list li:last-child {
            border-bottom: none;
        }

        .currency-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .currency-selector label {
            margin-bottom: 0;
            font-weight: 500;
        }

        .currency-selector select {
            width: auto;
            min-width: 100px;
        }

        footer {
            background-color: var(--dark);
            color: white;
            padding: 40px 0 20px;
            margin-top: 40px;
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .footer-links {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .footer-links a {
            color: white;
            text-decoration: none;
            opacity: 0.8;
            transition: var(--transition);
        }

        .footer-links a:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .copyright {
            color: #a0aec0;
            font-size: 0.9rem;
        }

        .download-settlement-btn {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .settlement-image {
            max-width: 100%;
            display: none;
        }

        /* Modal styles for bill editing */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .group-total {
            font-weight: bold;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 20px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }

            .group-card {
                padding-right: 20px;
            }

            .group-actions {
                position: static;
                margin-top: 15px;
                justify-content: flex-end;
            }

            .bill-card {
                padding-right: 20px;
            }

            .bill-actions {
                position: static;
                margin-top: 10px;
                justify-content: flex-end;
            }

            .currency-selector {
                flex-direction: column;
                align-items: flex-start;
            }

            .currency-selector select {
                width: 100%;
            }

            .download-settlement-btn {
                position: static;
                margin-top: 15px;
                width: 100%;
            }

            .modal-content {
                width: 90%;
                padding: 20px;
            }
        }
    </style>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Split your group expenses fairly and easily with BillSplitPro – a free bill splitting and settlement tool.">
    <meta name="keywords" content="bill splitter, split bills, expense manager, group expenses, fair share calculator, friends expenses">
    <meta name="robots" content="index, follow">

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</head>
<body>
    <header>
        <div class="container header-container">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="logo-text">Bill<span>Split</span>Pro</div>
            </div>
        </div>
    </header>

<!-- Ad Slot -->
<div class="container ad-slot" style="margin: 30px auto; text-align: center;">
    <!-- Replace with your AdSense ID and Ad Unit ID -->
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-xxxxxxxxxxxxxxxx"
         data-ad-slot="ad-slot-id"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>


    <main class="container">
        <!-- Back Button -->
        <button id="backButton" class="btn back-button hidden">← Back to Groups</button>
        
        <!-- Group Selection Screen -->
        <div id="groupScreen">
            <div class="app-container">
                <h1>Bill Splitter</h1>

<!-- Ad Slot -->
<div class="container ad-slot" style="margin: 30px auto; text-align: center;">
    <!-- Replace with your AdSense ID and Ad Unit ID -->
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-xxxxxxxxxxxxxxxx"
         data-ad-slot="ad-slot-id"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>

                <p class="subtitle">Fairly split expenses among friends, roommates, or group members</p>
                
                <div class="currency-selector">
                    <label for="currency">Currency:</label>
                    <select id="currency">
                        <option value="INR" selected>Indian Rupee (₹)</option>
                        <option value="USD">US Dollar ($)</option>
                        <option value="EUR">Euro (€)</option>
                        <option value="GBP">British Pound (£)</option>
                        <option value="JPY">Japanese Yen (¥)</option>
                        <option value="AUD">Australian Dollar (A$)</option>
                        <option value="CAD">Canadian Dollar (C$)</option>
                    </select>
                </div>
                
                <h2>Your Groups</h2>
                <div id="existingGroups">
                    <!-- Groups will be loaded here -->
                    <div class="empty-state">No groups found. Create your first group!</div>
                </div>
                
                <h2>Create New Group</h2>
                <div class="form-group">
                    <label for="groupName">Group Name</label>
                    <input type="text" id="groupName" placeholder="Enter group name">
                </div>
                
                <div class="form-group">
                    <label for="memberInput">Add Members</label>
                    <div class="member-input-container">
                        <input type="text" id="memberInput" placeholder="Enter member name">
                        <button id="addMemberBtn" class="btn btn-secondary">Add</button>
                    </div>
                    <div id="membersContainer" style="margin-top: 10px;">
                        <!-- Members will be added here -->
                    </div>
                </div>
                
                <button id="createGroupBtn" class="btn btn-secondary">Create Group</button>
            </div>
        </div>
        
        <!-- Bill Management Screen -->
        <div id="billScreen" class="hidden">
            <div class="app-container">
                <h1 id="currentGroupTitle">Group Name</h1>
                
                <h2>Add New Bill</h2>
                <div class="form-group">
                    <label for="billAmount">Amount</label>
                    <div style="display: flex; align-items: center;">
                        <span id="currencySymbol" style="margin-right: 10px; font-weight: bold;">₹</span>
                        <input type="number" id="billAmount" placeholder="0.00" step="0.01" style="flex-grow: 1;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="paidBy">Paid By</label>
                    <select id="paidBy">
                        <option value="">Select who paid</option>
                        <!-- Options will be added dynamically -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="billDescription">Description</label>
                    <input type="text" id="billDescription" placeholder="What was this for?">
                </div>
                
                <div class="button-group">
                    <button id="addBillBtn" class="btn">Add Bill</button>
                    <button id="backToGroupsBtn" class="btn btn-outline">Back to Groups</button>
                </div>
                
                <h2>Bills</h2>
                <div id="billsContainer">
                    <!-- Bills will be displayed here -->
                    <div class="empty-state">No bills added yet</div>
                </div>
                
                <div class="settlement-card">
                    <h2>Settlement</h2>
                    <button id="downloadSettlementBtn" class="btn btn-secondary download-settlement-btn">
                        <i class="fas fa-download"></i> Download as Image
                    </button>
                    <div id="settlementInfo">
                        <!-- Settlement info will be displayed here -->
                        <div class="empty-state">Add bills to see settlement information</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bill Edit Modal -->
        <div id="editBillModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Edit Bill</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="form-group">
                    <label for="editBillAmount">Amount</label>
                    <div style="display: flex; align-items: center;">
                        <span id="editCurrencySymbol" style="margin-right: 10px; font-weight: bold;">₹</span>
                        <input type="number" id="editBillAmount" placeholder="0.00" step="0.01" style="flex-grow: 1;">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editPaidBy">Paid By</label>
                    <select id="editPaidBy">
                        <option value="">Select who paid</option>
                        <!-- Options will be added dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="editBillDescription">Description</label>
                    <input type="text" id="editBillDescription" placeholder="What was this for?">
                </div>
                <div class="modal-footer">
                    <button id="cancelEditBillBtn" class="btn btn-outline">Cancel</button>
                    <button id="saveEditBillBtn" class="btn btn-secondary">Save Changes</button>
                </div>
                <input type="hidden" id="editBillId">
            </div>
        </div>
    
<!-- Ad Slot -->
<div class="container ad-slot" style="margin: 30px auto; text-align: center;">
    <!-- Replace with your AdSense ID and Ad Unit ID -->
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-xxxxxxxxxxxxxxxx"
         data-ad-slot="ad-slot-id"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>

</main>

    <footer>
        <div class="container footer-content">
            <div class="footer-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Service</a>
                <a href="#">Contact Us</a>
                <a href="#">About</a>
            </div>
            <p class="copyright">© 2023 BillSplitPro. All rights reserved.</p>
        </div>
    </footer>

    <!-- Include libraries -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <script>
        // App State
        let currentView = 'groups';
        let currentGroupId = null;
        let newGroupMembers = [];
        let currentCurrency = 'INR';
        const currencySymbols = {
            'INR': '₹',
            'USD': '$',
            'EUR': '€',
            'GBP': '£',
            'JPY': '¥',
            'AUD': 'A$',
            'CAD': 'C$'
        };
        
        // DOM Elements
        const backButton = document.getElementById('backButton');
        const groupScreen = document.getElementById('groupScreen');
        const billScreen = document.getElementById('billScreen');
        const existingGroups = document.getElementById('existingGroups');
        const membersContainer = document.getElementById('membersContainer');
        const billsContainer = document.getElementById('billsContainer');
        const currentGroupTitle = document.getElementById('currentGroupTitle');
        const paidBySelect = document.getElementById('paidBy');
        const settlementInfo = document.getElementById('settlementInfo');
        const currencySelect = document.getElementById('currency');
        const currencySymbol = document.getElementById('currencySymbol');
        const downloadSettlementBtn = document.getElementById('downloadSettlementBtn');
        const backToGroupsBtn = document.getElementById('backToGroupsBtn');
        
        // Modal elements
        const editBillModal = document.getElementById('editBillModal');
        const editBillAmount = document.getElementById('editBillAmount');
        const editPaidBy = document.getElementById('editPaidBy');
        const editBillDescription = document.getElementById('editBillDescription');
        const editBillId = document.getElementById('editBillId');
        const editCurrencySymbol = document.getElementById('editCurrencySymbol');
        const saveEditBillBtn = document.getElementById('saveEditBillBtn');
        const cancelEditBillBtn = document.getElementById('cancelEditBillBtn');
        const closeModalBtn = document.querySelector('.close-modal');
        
        // IndexedDB variables
        let db;
        const DB_NAME = 'BillSplitterDB';
        const DB_VERSION = 4; // Incremented version for new features
        const STORE_NAME = 'groups';

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async () => {
            await initDB();
            await loadGroups();
            setupEventListeners();
            updateCurrencySymbol();
        });
        
        // Initialize IndexedDB
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (event) => {
                    console.error('Database error:', event.target.error);
                    reject('Database error');
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    
                    // Add error handler for future transactions
                    db.onerror = function(event) {
                        console.error('Database error:', event.target.error);
                    };
                    
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
            });
        }
        
        // Event Listeners
        function setupEventListeners() {
            backButton.addEventListener('click', () => {
                showGroupScreen();
            });
            
            backToGroupsBtn.addEventListener('click', () => {
                showGroupScreen();
            });
            
            document.getElementById('addMemberBtn').addEventListener('click', addNewMember);
            document.getElementById('createGroupBtn').addEventListener('click', createNewGroup);
            document.getElementById('addBillBtn').addEventListener('click', addNewBill);
            downloadSettlementBtn.addEventListener('click', downloadSettlementAsImage);
            
            // Handle Enter key in member input
            document.getElementById('memberInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addNewMember();
                }
            });
            
            // Currency change handler
            currencySelect.addEventListener('change', function() {
                currentCurrency = this.value;
                updateCurrencySymbol();
                
                // Reload bills to update currency display
                if (currentGroupId) {
                    loadCurrentGroup();
                }
            });
            
            // Modal event listeners
            saveEditBillBtn.addEventListener('click', saveEditedBill);
            cancelEditBillBtn.addEventListener('click', closeEditModal);
            closeModalBtn.addEventListener('click', closeEditModal);
            
            // Close modal when clicking outside
            editBillModal.addEventListener('click', (e) => {
                if (e.target === editBillModal) {
                    closeEditModal();
                }
            });
        }
        
        // Helper to load the current group and update UI
        async function loadCurrentGroup() {
            const groups = await getGroupsFromStorage();
            const group = groups.find(g => g.id === currentGroupId);
            if (group) {
                renderBills(group.bills);
                calculateSettlements(group);
            }
        }
        
        function updateCurrencySymbol() {
            currencySymbol.textContent = currencySymbols[currentCurrency] || '₹';
            editCurrencySymbol.textContent = currencySymbols[currentCurrency] || '₹';
        }
        
        function formatCurrency(amount) {
            return `${currencySymbols[currentCurrency] || '₹'}${parseFloat(amount).toFixed(2)}`;
        }
        
        // Calculate total amount for a group
        function calculateGroupTotal(bills) {
            return bills.reduce((total, bill) => total + bill.amount, 0);
        }
        
        // IndexedDB Operations
        async function getGroupsFromStorage() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    resolve(request.result || []);
                };
                
                request.onerror = () => {
                    console.error('Error loading groups from IndexedDB');
                    reject('Error loading groups');
                };
            });
        }
        
        async function saveGroupsToStorage(groups) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                // Clear existing data
                const clearRequest = store.clear();
                
                clearRequest.onsuccess = () => {
                    // Add all groups
                    const putRequests = groups.map(group => {
                        return new Promise((innerResolve, innerReject) => {
                            const request = store.put(group);
                            request.onsuccess = innerResolve;
                            request.onerror = innerReject;
                        });
                    });
                    
                    Promise.all(putRequests)
                        .then(() => {
                            transaction.oncomplete = () => {
                                resolve(true);
                            };
                        })
                        .catch(error => {
                            console.error('Error saving groups:', error);
                            reject(false);
                        });
                };
                
                clearRequest.onerror = () => {
                    console.error('Error clearing store');
                    reject(false);
                };
                
                transaction.onerror = () => {
                    console.error('Transaction error');
                    reject(false);
                };
            });
        }
        
        // Group Management
        function addNewMember() {
            const memberInput = document.getElementById('memberInput');
            const memberName = memberInput.value.trim();
            
            if (memberName && !newGroupMembers.includes(memberName)) {
                newGroupMembers.push(memberName);
                memberInput.value = '';
                renderMembersList();
            }
        }
        
        function renderMembersList() {
            membersContainer.innerHTML = '';
            newGroupMembers.forEach(member => {
                const tag = document.createElement('span');
                tag.className = 'member-tag';
                tag.textContent = member;
                membersContainer.appendChild(tag);
            });
        }
        
        async function createNewGroup() {
            const groupName = document.getElementById('groupName').value.trim();
            
            if (!groupName || newGroupMembers.length === 0) {
                alert('Please enter a group name and add at least one member');
                return;
            }
            
            try {
                const groups = await getGroupsFromStorage();
                const newGroup = {
                    id: Date.now().toString(),
                    name: groupName,
                    members: [...newGroupMembers],
                    bills: [],
                    currency: currentCurrency,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                groups.push(newGroup);
                
                if (await saveGroupsToStorage(groups)) {
                    // Reset form
                    document.getElementById('groupName').value = '';
                    document.getElementById('memberInput').value = '';
                    newGroupMembers = [];
                    membersContainer.innerHTML = '';
                    
                    loadGroups();
                } else {
                    alert('Failed to save group. Please try again.');
                }
            } catch (error) {
                console.error('Error creating group:', error);
                alert('An error occurred while creating the group. Please try again.');
            }
        }
        
        async function loadGroups() {
            try {
                const groups = await getGroupsFromStorage();
                existingGroups.innerHTML = '';
                
                if (groups.length === 0) {
                    existingGroups.innerHTML = '<div class="empty-state">No groups found. Create your first group!</div>';
                    return;
                }
                
                groups.forEach(group => {
                    const totalAmount = calculateGroupTotal(group.bills);
                    const groupCard = document.createElement('div');
                    groupCard.className = 'group-card';
                    groupCard.innerHTML = `
                        <h3>${group.name}</h3>
                        <p>Members: ${group.members.join(', ')}</p>
                        <p>Total bills: ${group.bills.length}</p>
                        <p class="group-total">Total amount: ${formatCurrency(totalAmount)}</p>
                        <div class="group-actions">
                            <button data-group-id="${group.id}" class="btn open-group-btn">Open</button>
                            <button data-group-id="${group.id}" class="btn btn-danger delete-group-btn">Delete</button>
                        </div>
                    `;
                    existingGroups.appendChild(groupCard);
                });
                
                document.querySelectorAll('.open-group-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        openGroup(e.target.getAttribute('data-group-id'));
                    });
                });
                
                document.querySelectorAll('.delete-group-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const groupId = e.target.getAttribute('data-group-id');
                        if (confirm('Are you sure you want to delete this group and all its bills?')) {
                            try {
                                const groups = await getGroupsFromStorage();
                                const updatedGroups = groups.filter(g => g.id !== groupId);
                                await saveGroupsToStorage(updatedGroups);
                                loadGroups();
                                
                                if (currentGroupId === groupId) {
                                    showGroupScreen();
                                }
                            } catch (error) {
                                console.error('Error deleting group:', error);
                                alert('Failed to delete group. Please try again.');
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading groups:', error);
                existingGroups.innerHTML = '<div class="empty-state">Error loading groups. Please refresh the page.</div>';
            }
        }
        
        async function openGroup(groupId) {
            try {
                const groups = await getGroupsFromStorage();
                const group = groups.find(g => g.id === groupId);
                
                if (!group) return;
                
                currentGroupId = groupId;
                currentGroupTitle.textContent = group.name;
                
                // Set currency to group's currency or default
                currentCurrency = group.currency || 'INR';
                currencySelect.value = currentCurrency;
                updateCurrencySymbol();
                
                // Update paid by dropdown
                paidBySelect.innerHTML = '<option value="">Select who paid</option>';
                group.members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    paidBySelect.appendChild(option);
                });
                
                // Load bills
                renderBills(group.bills);
                calculateSettlements(group);
                
                showBillScreen();
            } catch (error) {
                console.error('Error opening group:', error);
                alert('Failed to open group. Please try again.');
            }
        }
        
        // Bill Management
        async function addNewBill() {
            const amount = parseFloat(document.getElementById('billAmount').value);
            const paidBy = document.getElementById('paidBy').value;
            const description = document.getElementById('billDescription').value.trim();
            
            if (!amount || !paidBy || !description) {
                alert('Please fill all bill details');
                return;
            }
            
            try {
                const groups = await getGroupsFromStorage();
                const groupIndex = groups.findIndex(g => g.id === currentGroupId);
                
                if (groupIndex === -1) {
                    alert('Group not found. Please refresh and try again.');
                    return;
                }
                
                const newBill = {
                    id: Date.now().toString(),
                    amount,
                    paidBy,
                    description,
                    date: new Date().toLocaleDateString(),
                    currency: currentCurrency,
                    addedAt: new Date().toISOString()
                };
                
                groups[groupIndex].bills.push(newBill);
                groups[groupIndex].currency = currentCurrency;
                groups[groupIndex].updatedAt = new Date().toISOString();
                
                if (await saveGroupsToStorage(groups)) {
                    // Reset form
                    document.getElementById('billAmount').value = '';
                    document.getElementById('paidBy').value = '';
                    document.getElementById('billDescription').value = '';
                    
                    // Update UI
                    renderBills(groups[groupIndex].bills);
                    calculateSettlements(groups[groupIndex]);
                } else {
                    alert('Failed to save bill. Please try again.');
                }
            } catch (error) {
                console.error('Error adding bill:', error);
                alert('An error occurred while adding the bill. Please try again.');
            }
        }
        
        function renderBills(bills) {
            billsContainer.innerHTML = '';
            
            if (!bills || bills.length === 0) {
                billsContainer.innerHTML = '<div class="empty-state">No bills added yet</div>';
                return;
            }
            
            bills.forEach(bill => {
                const billCard = document.createElement('div');
                billCard.className = 'bill-card';
                billCard.innerHTML = `
                    <p><strong>${bill.description}</strong> - ${formatCurrency(bill.amount)}</p>
                    <p>Paid by: ${bill.paidBy} on ${bill.date}</p>
                    <div class="bill-actions">
                        <button data-bill-id="${bill.id}" class="btn btn-warning edit-bill-btn">Edit</button>
                        <button data-bill-id="${bill.id}" class="btn btn-danger delete-bill-btn">Delete</button>
                    </div>
                `;
                billsContainer.appendChild(billCard);
            });
            
            // Add event listeners to edit buttons
            document.querySelectorAll('.edit-bill-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    openEditBillModal(e.target.getAttribute('data-bill-id'));
                });
            });
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-bill-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    deleteBill(e.target.getAttribute('data-bill-id'));
                });
            });
        }
        
        function openEditBillModal(billId) {
            // Get the current group and bill
            getGroupsFromStorage().then(groups => {
                const group = groups.find(g => g.id === currentGroupId);
                if (!group) return;
                
                const bill = group.bills.find(b => b.id === billId);
                if (!bill) return;
                
                // Fill the modal form with bill data
                editBillId.value = bill.id;
                editBillAmount.value = bill.amount;
                editBillDescription.value = bill.description;
                
                // Update paid by dropdown
                editPaidBy.innerHTML = '<option value="">Select who paid</option>';
                group.members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member;
                    option.textContent = member;
                    option.selected = member === bill.paidBy;
                    editPaidBy.appendChild(option);
                });
                
                // Show the modal
                editBillModal.style.display = 'flex';
            });
        }
        
        function closeEditModal() {
            editBillModal.style.display = 'none';
        }
        
        async function saveEditedBill() {
            const billId = editBillId.value;
            const amount = parseFloat(editBillAmount.value);
            const paidBy = editPaidBy.value;
            const description = editBillDescription.value.trim();
            
            if (!amount || !paidBy || !description) {
                alert('Please fill all bill details');
                return;
            }
            
            try {
                const groups = await getGroupsFromStorage();
                const groupIndex = groups.findIndex(g => g.id === currentGroupId);
                
                if (groupIndex === -1) {
                    alert('Group not found. Please refresh and try again.');
                    return;
                }
                
                // Find and update the bill
                const billIndex = groups[groupIndex].bills.findIndex(b => b.id === billId);
                if (billIndex === -1) {
                    alert('Bill not found. Please refresh and try again.');
                    return;
                }
                
                groups[groupIndex].bills[billIndex] = {
                    ...groups[groupIndex].bills[billIndex],
                    amount,
                    paidBy,
                    description,
                    updatedAt: new Date().toISOString()
                };
                
                groups[groupIndex].updatedAt = new Date().toISOString();
                
                if (await saveGroupsToStorage(groups)) {
                    // Close modal and refresh UI
                    closeEditModal();
                    renderBills(groups[groupIndex].bills);
                    calculateSettlements(groups[groupIndex]);
                } else {
                    alert('Failed to save changes. Please try again.');
                }
            } catch (error) {
                console.error('Error editing bill:', error);
                alert('An error occurred while editing the bill. Please try again.');
            }
        }
        
        async function deleteBill(billId) {
            if (!confirm('Are you sure you want to delete this bill?')) {
                return;
            }
            
            try {
                const groups = await getGroupsFromStorage();
                const groupIndex = groups.findIndex(g => g.id === currentGroupId);
                
                if (groupIndex === -1) {
                    alert('Group not found. Please refresh and try again.');
                    return;
                }
                
                // Filter out the bill to be deleted
                groups[groupIndex].bills = groups[groupIndex].bills.filter(b => b.id !== billId);
                groups[groupIndex].updatedAt = new Date().toISOString();
                
                if (await saveGroupsToStorage(groups)) {
                    // Refresh UI
                    renderBills(groups[groupIndex].bills);
                    calculateSettlements(groups[groupIndex]);
                } else {
                    alert('Failed to delete bill. Please try again.');
                }
            } catch (error) {
                console.error('Error deleting bill:', error);
                alert('An error occurred while deleting the bill. Please try again.');
            }
        }
        
        function calculateSettlements(group) {
            if (!group || !group.members || !group.bills) {
                settlementInfo.innerHTML = '<div class="empty-state">Add bills to see settlement information</div>';
                return;
            }
            
            const members = group.members;
            const bills = group.bills;
            
            // Initialize balances
            const balances = {};
            members.forEach(member => {
                balances[member] = 0;
            });
            
            // Calculate balances
            bills.forEach(bill => {
                const share = bill.amount / members.length;
                balances[bill.paidBy] += bill.amount;
                
                members.forEach(member => {
                    balances[member] -= share;
                });
            });
            
            // Generate settlement text
            let settlementText = '';
            const transactions = [];
            
            // Create a copy of balances for processing
            const balancesCopy = JSON.parse(JSON.stringify(balances));
            
            while (true) {
                // Find the person with the highest debt and highest credit
                let maxDebtor = null;
                let maxCreditor = null;
                let maxDebt = 0;
                let maxCredit = 0;
                
                for (const [person, balance] of Object.entries(balancesCopy)) {
                    if (balance < maxDebt) {
                        maxDebt = balance;
                        maxDebtor = person;
                    }
                    if (balance > maxCredit) {
                        maxCredit = balance;
                        maxCreditor = person;
                    }
                }
                
                // If no more debts or credits, we're done
                if (maxDebt >= 0 || maxCredit <= 0) break;
                
                // Calculate the amount to transfer
                const amount = Math.min(-maxDebt, maxCredit);
                transactions.push({
                    from: maxDebtor,
                    to: maxCreditor,
                    amount: amount
                });
                
                // Update balances
                balancesCopy[maxDebtor] += amount;
                balancesCopy[maxCreditor] -= amount;
            }
            
            if (transactions.length === 0) {
                settlementText = '<p>Everything is balanced! No payments needed.</p>';
            } else {
                settlementText = '<ul class="results-list">';
                transactions.forEach(tx => {
                    settlementText += `<li><strong>${tx.from}</strong> owes <strong>${tx.to}</strong> ${formatCurrency(tx.amount)}</li>`;
                });
                settlementText += '</ul>';
            }
            
            settlementInfo.innerHTML = settlementText;
        }
        
        async function downloadSettlementAsImage() {
            try {
                const groups = await getGroupsFromStorage();
                const group = groups.find(g => g.id === currentGroupId);
                
                if (!group) {
                    alert('Group not found. Please refresh and try again.');
                    return;
                }
                
                // Create a container for the image content
                const imageContainer = document.createElement('div');
                imageContainer.style.backgroundColor = 'white';
                imageContainer.style.padding = '20px';
                imageContainer.style.maxWidth = '600px';
                imageContainer.style.margin = '0 auto';
                imageContainer.style.fontFamily = 'Arial, sans-serif';
                
                // Add group title
                const title = document.createElement('h1');
                title.textContent = group.name;
                title.style.color = '#2d3748';
                title.style.textAlign = 'center';
                title.style.marginBottom = '20px';
                imageContainer.appendChild(title);
                
                // Add bills section
                const billsTitle = document.createElement('h2');
                billsTitle.textContent = 'Bills';
                billsTitle.style.color = '#4a6bdf';
                billsTitle.style.fontSize = '22px';
                billsTitle.style.marginTop = '30px';
                billsTitle.style.paddingBottom = '10px';
                billsTitle.style.borderBottom = '1px solid #e2e8f0';
                imageContainer.appendChild(billsTitle);
                
                if (group.bills.length === 0) {
                    const emptyState = document.createElement('p');
                    emptyState.textContent = 'No bills added yet';
                    emptyState.style.textAlign = 'center';
                    emptyState.style.color = '#718096';
                    imageContainer.appendChild(emptyState);
                } else {
                    group.bills.forEach(bill => {
                        const billDiv = document.createElement('div');
                        billDiv.style.borderLeft = '3px solid #4a6bdf';
                        billDiv.style.paddingLeft = '15px';
                        billDiv.style.marginBottom = '15px';
                        
                        const desc = document.createElement('p');
                        desc.innerHTML = `<strong>${bill.description}</strong> - ${formatCurrency(bill.amount)}`;
                        
                        const details = document.createElement('p');
                        details.textContent = `Paid by: ${bill.paidBy} on ${bill.date}`;
                        
                        billDiv.appendChild(desc);
                        billDiv.appendChild(details);
                        imageContainer.appendChild(billDiv);
                    });
                }
                
                // Add settlement section
                const settlementTitle = document.createElement('h2');
                settlementTitle.textContent = 'Settlement';
                settlementTitle.style.color = '#4a6bdf';
                settlementTitle.style.fontSize = '22px';
                settlementTitle.style.marginTop = '30px';
                settlementTitle.style.paddingBottom = '10px';
                settlementTitle.style.borderBottom = '1px solid #e2e8f0';
                imageContainer.appendChild(settlementTitle);
                
                // Calculate settlements for the image
                const members = group.members;
                const bills = group.bills;
                const balances = {};
                members.forEach(member => {
                    balances[member] = 0;
                });
                
                bills.forEach(bill => {
                    const share = bill.amount / members.length;
                    balances[bill.paidBy] += bill.amount;
                    
                    members.forEach(member => {
                        balances[member] -= share;
                    });
                });
                
                const transactions = [];
                const balancesCopy = JSON.parse(JSON.stringify(balances));
                
                while (true) {
                    let maxDebtor = null;
                    let maxCreditor = null;
                    let maxDebt = 0;
                    let maxCredit = 0;
                    
                    for (const [person, balance] of Object.entries(balancesCopy)) {
                        if (balance < maxDebt) {
                            maxDebt = balance;
                            maxDebtor = person;
                        }
                        if (balance > maxCredit) {
                            maxCredit = balance;
                            maxCreditor = person;
                        }
                    }
                    
                    if (maxDebt >= 0 || maxCredit <= 0) break;
                    
                    const amount = Math.min(-maxDebt, maxCredit);
                    transactions.push({
                        from: maxDebtor,
                        to: maxCreditor,
                        amount: amount
                    });
                    
                    balancesCopy[maxDebtor] += amount;
                    balancesCopy[maxCreditor] -= amount;
                }
                
                if (transactions.length === 0) {
                    const balancedText = document.createElement('p');
                    balancedText.textContent = 'Everything is balanced! No payments needed.';
                    balancedText.style.textAlign = 'center';
                    balancedText.style.color = '#718096';
                    imageContainer.appendChild(balancedText);
                } else {
                    const transactionsList = document.createElement('ul');
                    transactionsList.style.listStyleType = 'none';
                    transactionsList.style.padding = '0';
                    
                    transactions.forEach(tx => {
                        const li = document.createElement('li');
                        li.style.padding = '10px 0';
                        li.style.borderBottom = '1px solid #e2e8f0';
                        li.textContent = `${tx.from} owes ${tx.to} ${formatCurrency(tx.amount)}`;
                        transactionsList.appendChild(li);
                    });
                    
                    imageContainer.appendChild(transactionsList);
                }
                
                // Add footer with app name and date
                const footer = document.createElement('div');
                footer.style.marginTop = '30px';
                footer.style.textAlign = 'center';
                footer.style.fontSize = '14px';
                footer.style.color = '#718096';
                footer.textContent = `Generated by BillSplitPro on ${new Date().toLocaleDateString()}`;
                imageContainer.appendChild(footer);
                
                // Temporarily add to body for rendering
                document.body.appendChild(imageContainer);
                
                // Use html2canvas to create the image
                html2canvas(imageContainer).then(canvas => {
                    // Create download link
                    const link = document.createElement('a');
                    link.download = `${group.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_settlement.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    // Remove the temporary container
                    document.body.removeChild(imageContainer);
                }).catch(error => {
                    console.error('Error generating image:', error);
                    alert('Failed to generate settlement image. Please try again.');
                    document.body.removeChild(imageContainer);
                });
            } catch (error) {
                console.error('Error downloading settlement:', error);
                alert('An error occurred while generating the settlement image. Please try again.');
            }
        }
        
        // View Management
        function showGroupScreen() {
            currentView = 'groups';
            groupScreen.classList.remove('hidden');
            billScreen.classList.add('hidden');
            backButton.classList.add('hidden');
            loadGroups();
        }
        
        function showBillScreen() {
            currentView = 'bills';
            groupScreen.classList.add('hidden');
            billScreen.classList.remove('hidden');
            backButton.classList.remove('hidden');
        }
    </script>
</body>
</html>
